(function(a){typeof define=="function"&&define.amd?define(["underscore","jquery","backbone"],a):a(_,$,Backbone)})(function(a,b,c){if(!c)throw"Please include Backbone.js before Backbone.ModelBinder.js";return c.ModelBinder=function(){a.bindAll(this)},c.ModelBinder.VERSION="0.1.5",c.ModelBinder.Constants={},c.ModelBinder.Constants.ModelToView="ModelToView",c.ModelBinder.Constants.ViewToModel="ViewToModel",a.extend(c.ModelBinder.prototype,{bind:function(a,c,d){this.unbind(),this._model=a,this._rootEl=c;if(!this._model)throw"model must be specified";if(!this._rootEl)throw"rootEl must be specified";d?(this._attributeBindings=b.extend(!0,{},d),this._initializeAttributeBindings(),this._initializeElBindings()):this._initializeDefaultBindings(),this._bindModelToView(),this._bindViewToModel()},unbind:function(){this._unbindModelToView(),this._unbindViewToModel(),this._attributeBindings&&(delete this._attributeBindings,this._attributeBindings=undefined)},_initializeAttributeBindings:function(){var b,c,d,e,f;for(b in this._attributeBindings){c=this._attributeBindings[b];if(a.isString(c))d={elementBindings:[{selector:c}]};else if(a.isArray(c))d={elementBindings:c};else if(a.isObject(c))d={elementBindings:[c]};else throw"Unsupported type passed to Model Binder "+d;for(e=0;e<d.elementBindings.length;e++)f=d.elementBindings[e],f.attributeBinding=d;d.attributeName=b,this._attributeBindings[b]=d}},_initializeDefaultBindings:function(){var a,c,d,e;this._attributeBindings={},c=b("[name]",this._rootEl);for(a=0;a<c.length;a++){d=c[a],e=b(d).attr("name");if(!this._attributeBindings[e]){var f={attributeName:e};f.elementBindings=[{attributeBinding:f,boundEls:[d]}],this._attributeBindings[e]=f}else this._attributeBindings[e].elementBindings.push({attributeBinding:this._attributeBindings[e],boundEls:[d]})}},_initializeElBindings:function(){var a,c,d,e,f,g,h;for(a in this._attributeBindings){c=this._attributeBindings[a];for(d=0;d<c.elementBindings.length;d++){e=c.elementBindings[d],e.selector===""?f=b(this._rootEl):f=b(e.selector,this._rootEl);if(f.length===0)throw"Bad binding found. No elements returned for binding selector "+e.selector;e.boundEls=[];for(g=0;g<f.length;g++)h=f[g],e.boundEls.push(h)}}},_bindModelToView:function(){this._model.on("change",this._onModelChange,this),this.copyModelAttributesToView()},copyModelAttributesToView:function(b){var c,d;for(c in this._attributeBindings)if(b===undefined||a.indexOf(b,c)!==-1)d=this._attributeBindings[c],this._copyModelToView(d)},_unbindModelToView:function(){this._model&&(this._model.off("change",this._onModelChange),this._model=undefined)},_bindViewToModel:function(){b(this._rootEl).delegate("","change",this._onElChanged),b(this._rootEl).delegate("[contenteditable]","blur",this._onElChanged)},_unbindViewToModel:function(){this._rootEl&&(b(this._rootEl).undelegate("","change",this._onElChanged),b(this._rootEl).undelegate("[contenteditable]","blur",this._onElChanged))},_onElChanged:function(a){var c,d,e,f;c=b(a.target)[0],d=this._getElBindings(c);for(e=0;e<d.length;e++)f=d[e],this._isBindingUserEditable(f)&&this._copyViewToModel(f,c)},_isBindingUserEditable:function(a){return a.elAttribute===undefined||a.elAttribute==="text"||a.elAttribute==="html"},_getElBindings:function(a){var b,c,d,e,f,g,h=[];for(b in this._attributeBindings){c=this._attributeBindings[b];for(d=0;d<c.elementBindings.length;d++){e=c.elementBindings[d];for(f=0;f<e.boundEls.length;f++)g=e.boundEls[f],g===a&&h.push(e)}}return h},_onModelChange:function(){var a,b;for(a in this._model.changedAttributes())b=this._attributeBindings[a],b&&this._copyModelToView(b)},_copyModelToView:function(a){var d,e,f,g,h=this._model.get(a.attributeName);for(d=0;d<a.elementBindings.length;d++){e=a.elementBindings[d];if(!e.isSetting){var i=this._getConvertedValue(c.ModelBinder.Constants.ModelToView,e,h);for(f=0;f<e.boundEls.length;f++)g=e.boundEls[f],this._setEl(b(g),e,i)}}},_setEl:function(a,b,c){b.elAttribute?this._setElAttribute(a,b,c):this._setElValue(a,c)},_setElAttribute:function(b,d,e){switch(d.elAttribute){case"html":b.html(e);break;case"text":b.text(e);break;case"enabled":b.attr("disabled",!e);break;case"displayed":b[e?"show":"hide"]();break;case"hidden":b[e?"hide":"show"]();break;case"css":b.css(d.cssAttribute,e);break;case"class":var f=this._model.previous(d.attributeBinding.attributeName);a.isUndefined(f)||(f=this._getConvertedValue(c.ModelBinder.Constants.ModelToView,d,f),b.removeClass(f)),e&&b.addClass(e);break;default:b.attr(d.elAttribute,e)}},_setElValue:function(a,b){if(a.attr("type"))switch(a.attr("type")){case"radio":a.val()===b&&a.attr("checked","checked");break;case"checkbox":b?a.attr("checked","checked"):a.removeAttr("checked");break;default:a.val(b)}else a.is("input")||a.is("select")||a.is("textarea")?a.val(b):a.text(b)},_copyViewToModel:function(a,c){a.isSetting||(a.isSetting=!0,this._setModel(a,b(c)),a.converter&&this._copyModelToView(a.attributeBinding),a.isSetting=!1)},_getElValue:function(a,b){switch(b.attr("type")){case"checkbox":return b.prop("checked")?!0:!1;default:return b.attr("contenteditable")!==undefined?b.html():b.val()}},_setModel:function(a,b){var d={},e=this._getElValue(a,b);e=this._getConvertedValue(c.ModelBinder.Constants.ViewToModel,a,e),d[a.attributeBinding.attributeName]=e,this._model.set(d,{changeSource:"ModelBinder"})},_getConvertedValue:function(a,b,c){return b.converter&&(c=b.converter(a,c,b.attributeBinding.attributeName,this._model)),c}}),c.ModelBinder.CollectionConverter=function(b){this._collection=b;if(!this._collection)throw"Collection must be defined";a.bindAll(this,"convert")},a.extend(c.ModelBinder.CollectionConverter.prototype,{convert:function(a,b){return a===c.ModelBinder.Constants.ModelToView?b?b.id:undefined:this._collection.get(b)}}),c.ModelBinder.createDefaultBindings=function(a,c,d,e){var f,g,h,i,j={};f=b("["+c+"]",a);for(g=0;g<f.length;g++){h=f[g],i=b(h).attr(c);if(!j[i]){var k={selector:"["+c+'="'+i+'"]'};j[i]=k,d&&(j[i].converter=d),e&&(j[i].elAttribute=e)}}return j},c.ModelBinder.combineBindings=function(b,c){a.each(c,function(a,c){var d={selector:a.selector};a.converter&&(d.converter=a.converter),a.elAttribute&&(d.elAttribute=a.elAttribute),b[c]?b[c]=[b[c],d]:b[c]=d})},c.ModelBinder})